<!DOCTYPE html>
<html lang="en">
<style>
    p{
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
        font-size: 1.1rem;
    }
    figure{
        margin: 0 !important;
    }
    pre{
        padding: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
    }

    td{
        padding: 0 !important;
        margin-bottom: 1rem !important;
    }
    h1,h2,h3,h4,h5,h6{
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
    }
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hephesto - [GO]sync包</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/highlight.css">
    
<header class="bg-black text-hacker-white py-4 font-dos font-extrabold">
    <div class="container mx-auto flex items-center justify-between space-x-8">
    
      <h1 class="text-2xl font-bold ml-[100px] md:ml-0 animate-pulse text-hacker-color1 md:mr-[20%]">
        <a href="/" class="hover:text-white transition-colors select-none">
          Hephesto
        </a>
      </h1>
  
    <!-- 大屏幕 -->
      <nav class="hidden md:block">
        <ul class="flex space-x-6">
          
            <li>
              <a href="/" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Home
              </a>
            </li>
          
            <li>
              <a href="/archives" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Archives
              </a>
            </li>
          
            <li>
              <a href="/categories" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Categories
              </a>
            </li>
          
            <li>
              <a href="/tags" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Tags
              </a>
            </li>
          
            <li>
              <a href="/about" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                About
              </a>
            </li>
          
            <li>
              <a href="/rss.xml" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                RSS
              </a>
            </li>
          
        </ul>
      </nav>
  
      <!-- 小屏幕 -->
      <button id="menu-toggle" class="block md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
  
    <!-- 折叠菜单 -->
    <nav id="mobile-menu" class="hidden bg-black">
      <ul class="space-y-2 py-4 px-6">
        
          <li>
            <a href="/" class="block text-white hover:text-hacker-color1 transition-colors">
              Home
            </a>
          </li>
        
          <li>
            <a href="/archives" class="block text-white hover:text-hacker-color1 transition-colors">
              Archives
            </a>
          </li>
        
          <li>
            <a href="/categories" class="block text-white hover:text-hacker-color1 transition-colors">
              Categories
            </a>
          </li>
        
          <li>
            <a href="/tags" class="block text-white hover:text-hacker-color1 transition-colors">
              Tags
            </a>
          </li>
        
          <li>
            <a href="/about" class="block text-white hover:text-hacker-color1 transition-colors">
              About
            </a>
          </li>
        
          <li>
            <a href="/rss.xml" class="block text-white hover:text-hacker-color1 transition-colors">
              RSS
            </a>
          </li>
        
      </ul>
    </nav>
  
    <!-- RSS Link -->
    <link rel="alternate" type="application/rss+xml" title=" RSS" href="/rss.xml" />
  </header>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/search.js"></script>
  <script>
        document.addEventListener("DOMContentLoaded", () => {
    const menuToggle = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");

    menuToggle.addEventListener("click", () => {
        if (mobileMenu.classList.contains("hidden")) {
        mobileMenu.classList.remove("hidden");
        } else {
        mobileMenu.classList.add("hidden");
        }
    });
    });

  </script>
  

<meta name="generator" content="Hexo 7.3.0"></head>
<body class="bg-black text-hacker-color3 container mx-auto">
    <!-- 文章标题 -->
    <h1 class="text-5xl text-hacker-color1 font-bold font-dos my-6 text-center">[GO]sync包</h1>

    <!-- 发布时间 -->
    <p class="text-hacker-color3 text-center text-sm mb-4">
        2025-02-23
    </p>

    <!-- 文章内容 -->
    <div id="article-content" class="article-entry prose prose-invert mx-auto max-w-4xl leading-relaxed highlight">
        <h1 id="sync包"><a href="#sync包" class="headerlink" title="sync包"></a>sync包</h1><h2 id="sync包工具："><a href="#sync包工具：" class="headerlink" title="sync包工具："></a>sync包工具：</h2><pre><code>1. 互斥锁：Mutex
2. 读写锁：RWMutex
3. 等待组： WaitGroup
4. 并发安全字典：Map
5. 单例模式：Once
</code></pre>
<h3 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex:"></a>Mutex:</h3><ul>
<li>保证在同一时间只有一个goroutine持有锁</li>
<li>保证了在这一时间段内只有这以一个goroutine可以访问共享资源,其他goroutine会被堵塞直到锁被释放</li>
</ul>
<h3 id="RWMutex："><a href="#RWMutex：" class="headerlink" title="RWMutex："></a>RWMutex：</h3><ul>
<li>在同一时间只有一个goroutine获得WLock</li>
<li>在同一时间可以有多个goroutine获得RLock</li>
<li>在同一时间只能存在写锁hi哦这读锁，即读写锁互斥</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> p = fmt.Println<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	p(<span class="hljs-string">&quot;main func starts&quot;</span>)<br>	<span class="hljs-keyword">var</span> lock sync.RWMutex<br>	<span class="hljs-comment">// GOTIME := &quot;2025-1-2 15:04:23&quot;</span><br><br>	p(<span class="hljs-string">&quot;start rlock at: &quot;</span>, time.Now())<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> <span class="hljs-number">5</span> &#123;<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> lock.RUnlock()<br>			lock.RLock()<br>			p(<span class="hljs-string">&quot;func&quot;</span>, i, <span class="hljs-string">&quot;gets rlock at: &quot;</span>, time.Now())<br>			time.Sleep(time.Second)<br>			p(<span class="hljs-string">&quot;func&quot;</span>, i, <span class="hljs-string">&quot;release rlock at: &quot;</span>, time.Now())<br>		&#125;(i)<br>	&#125;<br>	time.Sleep(time.Second / <span class="hljs-number">10</span>)<br><br>	p(<span class="hljs-string">&quot;============================================&quot;</span>)<br>	p(<span class="hljs-string">&quot;start wlock at:&quot;</span>, time.Now())<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> <span class="hljs-number">5</span> &#123;<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> lock.Unlock()<br>			lock.Lock()<br>			p(<span class="hljs-string">&quot;func&quot;</span>, i, <span class="hljs-string">&quot;gets wlock at: &quot;</span>, time.Now())<br>			time.Sleep(time.Second)<br>			p(<span class="hljs-string">&quot;func&quot;</span>, i, <span class="hljs-string">&quot;release wlock at: &quot;</span>, time.Now())<br>		&#125;(i)<br>	&#125;<br>	time.Sleep(<span class="hljs-number">10</span> * time.Second)<br><br>	p(<span class="hljs-string">&quot;main func is done&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs output">main func starts<br>start rlock at:  2025-02-23 20:31:33.9404441 +0800 CST m=+0.000566301<br>func 4 gets rlock at:  2025-02-23 20:31:33.953563 +0800 CST m=+0.013685201<br>func 1 gets rlock at:  2025-02-23 20:31:33.953563 +0800 CST m=+0.013685201<br>func 0 gets rlock at:  2025-02-23 20:31:33.953563 +0800 CST m=+0.013685201<br>func 3 gets rlock at:  2025-02-23 20:31:33.953563 +0800 CST m=+0.013685201<br>func 2 gets rlock at:  2025-02-23 20:31:33.953563 +0800 CST m=+0.013685201<br>============================================<br>start wlock at: 2025-02-23 20:31:34.0541687 +0800 CST m=+0.114290901<br>func 4 release rlock at:  2025-02-23 20:31:34.9540295 +0800 CST m=+1.014151701<br>func 1 release rlock at:  2025-02-23 20:31:34.9540295 +0800 CST m=+1.014151701<br>func 2 release rlock at:  2025-02-23 20:31:34.954599 +0800 CST m=+1.014721201<br>func 3 release rlock at:  2025-02-23 20:31:34.954599 +0800 CST m=+1.014721201<br>func 0 release rlock at:  2025-02-23 20:31:34.954599 +0800 CST m=+1.014721201<br>func 4 gets wlock at:  2025-02-23 20:31:34.9555688 +0800 CST m=+1.015691001<br>func 4 release wlock at:  2025-02-23 20:31:35.9565869 +0800 CST m=+2.016709101<br>func 0 gets wlock at:  2025-02-23 20:31:35.956899 +0800 CST m=+2.017021201<br>func 0 release wlock at:  2025-02-23 20:31:36.957694 +0800 CST m=+3.017816201<br>func 1 gets wlock at:  2025-02-23 20:31:36.9583138 +0800 CST m=+3.018436001<br>func 1 release wlock at:  2025-02-23 20:31:37.9589584 +0800 CST m=+4.019080601<br>func 2 gets wlock at:  2025-02-23 20:31:37.9596494 +0800 CST m=+4.019771601<br>func 2 release wlock at:  2025-02-23 20:31:38.9608447 +0800 CST m=+5.020966901<br>func 3 gets wlock at:  2025-02-23 20:31:38.961154 +0800 CST m=+5.021276201<br>func 3 release wlock at:  2025-02-23 20:31:39.96198 +0800 CST m=+6.022102201<br>main func is done<br></code></pre></td></tr></table></figure>



<h3 id="Map"><a href="#Map" class="headerlink" title="Map:"></a>Map:</h3><ul>
<li>go原生中的map不是并发安全的，当多个goroutine同时往map中添加数据时，可能会导致部分数据丢失</li>
<li>在同一个Map中可以存储多个不同类型的KV对</li>
</ul>
<p><strong>map中的方法：</strong></p>
<ol>
<li><p>func  (m *Map) <strong>Load</strong>(key any)(value any, ok bool)</p>
<p>由k获得value（相当于get）</p>
</li>
<li><p>func (m *Map) <strong>Store</strong>(key, value any)</p>
<p>存储（set）</p>
</li>
<li><p>func (m *Map)<strong>LoadOrStore</strong>(key, value any) (actual any, loaded bool)</p>
<p>如果key存在，返回对应的value，否则存储</p>
</li>
<li><p>func (m *Map) <strong>Delete</strong>(key any)</p>
<p>删除一个key</p>
</li>
<li><p>func (m *Map) <strong>Range</strong>(f func(key, value any),bool)</p>
<p>无序遍历map</p>
</li>
</ol>
<ul>
<li>参数 f 是一个回调函数，它接收两个 interface{} 类型的参数 key 和 value，分别表示当前遍历到的键和值。</li>
<li>回调函数返回一个 bool 类型的值，如果返回 true，则继续遍历下一个键值对；如果返回 false，则停止遍历。</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> p = fmt.Println<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> dict sync.Map<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> <span class="hljs-number">10</span> &#123;<br>		wg.Add(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> wg.Done()<br>			dict.Store(i, fmt.Sprintf(<span class="hljs-string">&quot;#stored %d#&quot;</span>, i))<br><br>		&#125;(i)<br>	&#125;<br>	wg.Wait()<br>	v, ok := dict.Load(<span class="hljs-number">1</span>)<br>	p(v, ok) <span class="hljs-comment">//#stored 1# true</span><br><br>	dict.Store(<span class="hljs-number">100</span>, <span class="hljs-string">&quot;#test100#&quot;</span>)<br><br>	dict.LoadOrStore(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;#test#&quot;</span>)<br>	p(dict.Load(<span class="hljs-number">10</span>)) <span class="hljs-comment">//#test# true</span><br><br>	v, loaded := dict.LoadAndDelete(<span class="hljs-number">9</span>)<br>	p(v, loaded)    <span class="hljs-comment">//#stored 9# true</span><br>	p(dict.Load(<span class="hljs-number">9</span>)) <span class="hljs-comment">//&lt;nil&gt; false</span><br><br>	p(<span class="hljs-string">&quot;===========================================&quot;</span>)<br>	dict.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value any)</span></span> <span class="hljs-type">bool</span> &#123;<br>		k := key.(<span class="hljs-type">int</span>)<br>		v := value.(<span class="hljs-type">string</span>)<br>		p(<span class="hljs-string">&quot;Key: %s, Value: %d\n&quot;</span>, k, v)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>


    </div>

    <!-- 返回主页链接 -->
    <div class="text-center my-8">
        <a href="/" class="text-hacker-color1 underline hover:text-hacker-color2">← Back to Home</a>
    </div>

    <footer class="bg-black text-gray-400 py-4">
    <div class="container mx-auto text-center">
      <p>© <span id="current-year"></span>  Hephesto 
        <br> Powered by <a class="hover:text-white duration-150 hover:underline decoration-slice" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a class="hover:text-white duration-150 hover:underline decoration-slice" target="_blank" rel="noopener" href="https://github.com/m310ct/hexo-theme-hexploit">Hexpolit</a></p>
    </div>
  </footer>
  
  <script> 
    document.getElementById("current-year").textContent = new Date().getFullYear();
  </script>
  


</body>
</html>
